## transfer_accounts_scheme
### 1. 需求
* 普通转账业务
    - a对b转账，a账户钱减少，b增加，保证总数不变
    - 重点是保证可靠性，系统可以挂，但钱不能损失
    - 感觉可以异步处理，过段时间提示转账是否成功，不过本次开发就当同步来做吧
* 群聊中抢红包
    - 群里所有人都能抢，包括自己
    - 一个红包中每个人所得的总和等于原红包的数值
    - 涉及接口请求高并发，多个群中同时进行抢红包活动（抢的不是同一个红包）
    - 要求同上，保证尽量快速响应前提下，可以有一定延迟，但钱不能损失
    - 参考微信红包，其实是同步响应的

### 2. 一些瞎想
* 主要问题：响应速度+可靠性
* 需要存储哪些数据？？？理论上每一步的记录都需要独立存储，另外还需要一个针对每次转账动作的总的记录，中间一个字段用于表示状态转移。然后是用户的账户本身记录
    - 各个阶段的单独记录日志（是不是直接记录文本日志比较好？？？）
    - 每条转账请求
    - 用户账户
* mysql账户表需要哪些字段？用户
* 如果对钱的操作使用mysql的乐观锁，可能响应速度会很快到达瓶颈
* 如果使用redis进行转账，每个人都有一个当前可用金额的记录和已经被冻结的金额的记录 hmset uid left 1000 frozen 200
* 转账通过redis实现，后期再落地到mysql，那么什么时候告诉用户转账已经成功了？哪些操作可以塞进队列进行后期做的？还是为了安全所有操作都应该实时操作
* 可靠性怎么保证，把整体流程画出来，然后考虑在每个节点处出现失败的时候的处理方式
* 要不要考虑主从同步的延迟？？？初步来看，问题不大，写操作都是主库，在进行写操作的时候需要进行合法性判断，redis原子操作？mysql乐观锁？
* 在转账执行过程中，外部查询数据，应该是什么效果？？？
* 金钱转出方应该把要转出的那部分钱冻结，查询余额的时候应该是left-frozen
* 金钱转入方不应该把要转入的钱算进来
* 应该就算资源的预隔离吧。。。
* 最后进行对账处理，这个应该准实时对账？还是每天定时开始统一对账？这是个大坑，目测我做不了。。。
* 对账应该分两大块，1.系统内部和外部接口（如调用了xx银行的接口进行扣款转账的时候），两者需要对账保证一致；2.系统内部各个账号之间需要保持一致性
* 外部接口目前暂时先不考虑吧
* 对账的依据是啥？怎么样就能判定为账目是正确的？
* 每日12时整的所有账户的金额需要记录（怎么记录？？？通过mysql的bin-log???据说这是数据库基本功能，这块参考官方文档，不考虑了）
* 如果有了xx日和xx+1日的账户信息

### 3. 方案设计
#### 3.1 基本流程
* 普通转账业务
    - 输入金额，发起转账申请到后端
    - 后端存储本次转账请求并返回一个针对本次转账的token
    - 前端输入账户密码，并携带上述token进行正式的转账请求
    - 后端通过tcc模式try-confirm-cancel进行转账操作
    - 每日定时脚本进行整体对账
* 群聊中抢红包
    - 
